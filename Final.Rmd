---
title: "Final"
author: "Shengzhi Luo"
date: "06/05/2022"
output: pdf_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(viridis)
library(mlbench)
library(ISLR)
library(caret)
library(e1071)
library(kernlab)
library(factoextra)
library(gridExtra)
library(corrplot)
library(RColorBrewer) 
library(gplots)
library(jpeg)
library(MASS)
library(pROC)
library(klaR)
library(pdp)
library(vip)
library(AppliedPredictiveModeling)
library(mgcv)
library(nlme)
library(rpart)
library(rpart.plot)
library(party)
library(partykit)
library(randomForest)
library(ranger)
library(gbm)
library(ggplot2)
library(ggpubr)
```

# Data load and pre-process

```{r message=FALSE}
# Load data, clean column names, eliminate indexs containing NA entries
heartattack = read_csv("heartattack.csv") %>%
              mutate(
                sex = factor(case_when(sex == 0 ~ "Female",
                                   sex == 1 ~ "Male")),
                exng = factor(case_when(exng == 0 ~ "no",
                                   exng == 1 ~ "yes")),
                cp = factor(case_when(cp == 3 ~ "typical angina",
                                      cp == 2 ~ "atypical angina",
                                      cp == 1 ~ "non-anginal pain",
                                      cp == 0 ~ "asymptomatic")),
                fbs = factor(case_when(fbs == 1 ~ "true",
                                   fbs == 0 ~ "false")),
                restecg = factor(case_when(restecg == 0 ~ "normal",
                                   restecg == 1 ~ "having ST-T wave abnormality",
                                   restecg == 2 ~ "showing probable or definite left ventricular hypertrophy by Estes' criteria")),
                output = factor(case_when(output== 0 ~ "less",
                                   output == 1 ~ "more")),
                output = fct_relevel(output, "less")
              )%>%
  na.omit()%>%
  dplyr::select(-oldpeak, -thall, -slp)

knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.align = "center")
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

```{r}
set.seed(100)
# Partition data into training/test sets
indexTrain = createDataPartition(y = heartattack$output,
                                 p = 0.7,
                                 list = FALSE)
training_df = heartattack[indexTrain, ]
testing_df = heartattack[-indexTrain, ]
# Create matrices for future analysis
# Training data
x_train = model.matrix(output~.,training_df)[, -11]
y_train = training_df$output
# Testing data
x_test <- model.matrix(output~.,testing_df)[, -11]
y_test <- testing_df$output
x_train_df = data.frame(x_train)
```

```{r}
summary(heartattack)
skimr::skim_without_charts(heartattack)
```

```{r}
theme1 = transparentTheme(trans = 0.4)
trellis.par.set(theme1)
featurePlot(x = heartattack %>% dplyr::select(age, caa, trtbps, thalachh,chol),
            y = heartattack$output,
            scales = list(x = list(relation = "free"),
                          y = list(relation = "free")),
            plot = "density", pch = "|",
            auto.key = list(columns = 2))
```

```{r}
par(mfrow = c(2, 3))
fp1 <- ggplot(training_df) + geom_bar(aes(x = sex)) 
fp2 <- ggplot(training_df) + geom_bar(aes(x = cp)) 
fp3 <- ggplot(training_df) + geom_bar(aes(x = fbs)) 
fp4 <- ggplot(training_df) + geom_bar(aes(x = restecg)) 
fp5 <- ggplot(training_df) + geom_bar(aes(x = exng))
figure <- ggarrange(fp1,fp2, fp3, fp4, fp5,
                    ncol = 2, nrow = 3)
figure
```



## glm
```{r}
set.seed(100)
ctrl = trainControl(method = "cv",
                    summaryFunction = twoClassSummary,
                    classProbs = TRUE)

model.glm <- train(output~.,
                    data=training_df,
                    method = "glm",
                    metric = "ROC",
                    trControl = ctrl)

```

## penalized glm
```{r}
glmnGrid <- expand.grid(.alpha = seq(0, 1, length = 11),
                        .lambda = exp(seq(2, -2, length = 35)))
set.seed(100)
model.glmn <- train(output~.,
                    data=training_df,
                    method = "glmnet",
                    tuneGrid = glmnGrid,
                    metric = "ROC",
                    trControl = ctrl)

model.glmn$bestTune

myCol<- rainbow(15)
myPar <- list(superpose.symbol = list(col = myCol),
              superpose.line = list(col = myCol))

plot(model.glmn, par.settings = myPar, xTrans = function(x) log(x))

```

## GAM
```{r}
set.seed(100)
gam.fit <- train(x_train,y_train,
                 method="gam",
                 metric = "ROC",
                 tuneGrid = data.frame(method = "GCV.Cp",select=c(TRUE,FALSE)),
                 trControl = ctrl)
gam.fit$bestTune
gam.fit$results
gam.fit$finalModel
```

## Mars
```{r, warning=FALSE}
set.seed(100)
model.mars <- train(x = heartattack[indexTrain,1:10],
                   y = heartattack$output[indexTrain],
                    method = "earth",
                    tuneGrid = expand.grid(degree = 1:3, 
                                           nprune = 2:15),
                    metric = "ROC",
                    trControl = ctrl)

plot(model.mars)

coef(model.mars$finalModel) %>% knitr::kable(col.names = "Coefficient") 

pdp::partial(model.mars, pred.var = c("age"), grid.resolution = 200) %>% autoplot()
vip(model.mars$finalModel)
```


## LDA

```{r}
partimat(output~age+caa+trtbps+chol+thalachh, method = "lda", data = heartattack)

lda.fit <- lda(output~., data = heartattack,subset = indexTrain)

plot(lda.fit, col = as.numeric(heartattack$output), abbrev = TRUE)

lda.fit$scaling

ctrl <- trainControl(method = "repeatedcv", 
                     repeats = 5,
                     summaryFunction = twoClassSummary,
                     classProbs = TRUE)

set.seed(100)

model.lda = train(output ~ .,
                  data = training_df,
                  method = "lda",
                  metric = "ROC",
                  trControl = ctrl)

```

# CTREE

```{r}
set.seed(100)

tree1 <- rpart(formula = output ~ . ,data = heartattack, subset = indexTrain, control = rpart.control(cp = 0))

rpart.plot(tree1)

printcp(tree1)

cpTable <- tree1$cptable
plotcp(tree1)

minErr <- which.min(cpTable[,4])
tree2 <- prune(tree1, cp = cpTable[minErr,1])
rpart.plot(tree2)

set.seed(100)
ctree.fit <- train(output ~ . , heartattack,
                   subset = indexTrain,
                   method = "ctree",
                   tuneGrid = data.frame(mincriterion = 1-exp(seq(-2, -1, length = 50))),
                   metric = "ROC",
                   trControl = ctrl)
```

# Random Tree

```{r}
set.seed(100)
rf <- randomForest(output~ . ,heartattack, subset = indexTrain ,mtry = 6)

set.seed(100)

rpart.fit <- train(output ~ . ,
                   heartattack,
                   subset = indexTrain,
                   method = "rpart",
                   tuneGrid = data.frame(cp = exp(seq(-6,-3, len = 50))),
                   trControl = ctrl,
                   metric = "ROC")
```

# Naive Bayes 
```{r}
nbGrid <- expand.grid(usekernel = c(FALSE,TRUE),
                      fL = 1,
                      adjust = seq(.1, 3, by = .1))
set.seed(100)

model.nb <- train(x = heartattack[indexTrain,1:10],
                  y = heartattack$output[indexTrain],
                  method = "nb",
                  tuneGrid = nbGrid,
                  metric = "ROC",
                  trControl = ctrl)

plot(model.nb)
```

```{r}
res <- resamples(list(LDA = model.lda,Rpart = rpart.fit, ctree = ctree.fit, glm = model.glm, glmn = model.glmn, Mars = model.mars))
summary(res)

newX <- model.matrix(~.-output, data = heartattack[-indexTrain,])

lda.pred <- predict(model.lda, newdata = heartattack[-indexTrain,], type = "prob")[,2]
rpart.pred <- predict(rpart.fit, newdata = heartattack[-indexTrain,],type = "prob")[,1]
ctree.pred <- predict(ctree.fit, newdata = heartattack[-indexTrain,],type = "prob")[,1]
glm.pred <- predict(model.glm, newdata = heartattack[-indexTrain,], type = "prob")[,2]
glmn.pred <- predict(model.glmn, newdata = newX, type = "prob")[,2]
mars.pred <- predict(model.mars, newdata = heartattack[-indexTrain,], type = "prob")[,2]

roc.lda <- roc(heartattack$output[-indexTrain], lda.pred)
roc.rpart <- roc(heartattack$output[-indexTrain], rpart.pred)
roc.ctree <- roc(heartattack$output[-indexTrain], ctree.pred)
roc.glm <- roc(heartattack$output[-indexTrain], glm.pred)
roc.glmn <- roc(heartattack$output[-indexTrain], glmn.pred)
roc.mars <- roc(heartattack$output[-indexTrain], mars.pred)

auc <- c(roc.lda$auc[1],roc.rpart$auc[1], roc.ctree$auc[1], roc.glm$auc[1], roc.glmn$auc[1], roc.mars$auc[1])


plot(roc.lda, legacy.axes = TRUE)
plot(roc.rpart, legacy.axes = TRUE)
plot(roc.ctree, col = 2, add = TRUE)
plot(roc.glm, col = 2, add = TRUE)
plot(roc.glmn, col = 2, add = TRUE)
plot(roc.mars, col = 2, add = TRUE)

modelNames <- c("lda", "rpart", "ctree", "glm", "glmn", "mars")

ggroc(list(roc.lda, roc.rpart ,roc.ctree, roc.glm, roc.glmn, roc.mars), legacy.axes = TRUE) +
scale_color_discrete(labels = paste0(modelNames, " (", round(auc,3),")"),
name = "Models (AUC)") +
geom_abline(intercept = 0, slope = 1, color = "grey")
```



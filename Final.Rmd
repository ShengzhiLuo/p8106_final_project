---
title: "Final"
author: "Shengzhi Luo"
date: "06/05/2022"
output: pdf_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(viridis)
library(mlbench)
library(ISLR)
library(caret)
library(e1071)
library(kernlab)
library(factoextra)
library(gridExtra)
library(corrplot)
library(RColorBrewer) 
library(gplots)
library(jpeg)
library(MASS)
library(pROC)
library(klaR)
library(pdp)
library(vip)
library(AppliedPredictiveModeling)
library(mgcv)
library(nlme)

heartattack = read_csv("heartattack.csv") %>%
              mutate(
                sex = factor(case_when(sex == 0 ~ "Female",
                                   sex == 1 ~ "Male")),
                cp = factor(case_when(cp == 1 ~ "typical angina",
                                      cp == 2 ~ "atypical angina",
                                      cp == 3 ~ "non-anginal pain",
                                      cp == 4 ~ "asymptomatic")),
                fbs = factor(case_when(fbs == 1 ~ "true",
                                   fbs == 0 ~ "false")),
                restecg = factor(case_when(restecg == 0 ~ "normal",
                                   restecg == 1 ~ "having ST-T wave abnormality",
                                   restecg == 2 ~ "showing probable or definite left ventricular hypertrophy by Estes' criteria")),
                output = factor(case_when(output== 0 ~ "less chance of heart attack",
                                   output == 1 ~ "more chance of heart attack"))
              )%>%
  na.omit()

knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.align = "center")
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

```{r message=FALSE}
# Load data, clean column names, eliminate rows containing NA entries
heartattack = read_csv("heartattack.csv") %>%
              mutate(
                sex = factor(case_when(sex == 0 ~ "Female",
                                   sex == 1 ~ "Male")),
                exng = factor(case_when(exng == 0 ~ "no",
                                   exng == 1 ~ "yes")),
                cp = factor(case_when(cp == 3 ~ "typical angina",
                                      cp == 2 ~ "atypical angina",
                                      cp == 1 ~ "non-anginal pain",
                                      cp == 0 ~ "asymptomatic")),
                fbs = factor(case_when(fbs == 1 ~ "true",
                                   fbs == 0 ~ "false")),
                restecg = factor(case_when(restecg == 0 ~ "normal",
                                   restecg == 1 ~ "having ST-T wave abnormality",
                                   restecg == 2 ~ "showing probable or definite left ventricular hypertrophy by Estes' criteria")),
                output = factor(case_when(output== 0 ~ "less",
                                   output == 1 ~ "more")),
                output = fct_relevel(output, "less")
              )%>%
  na.omit()%>%
  dplyr::select(-oldpeak, -thall, -slp)

set.seed(5009)
# Partition data into training/test sets
indexTrain = createDataPartition(y = heartattack$output,
                                 p = 0.7,
                                 list = FALSE)
training_df = heartattack[indexTrain, ]
testing_df = heartattack[-indexTrain, ]
# Create matrices for future analysis
# Training data
x_train = model.matrix(output~.,training_df)[, -11]
y_train = training_df$output
# Testing data
x_test <- model.matrix(output~.,testing_df)[, -11]
y_test <- testing_df$output
```


```{r}
summary(heartattack)
skimr::skim_without_charts(heartattack)
```


```{r}
theme1 = transparentTheme(trans = 0.4)
trellis.par.set(theme1)
featurePlot(x = heartattack %>% dplyr::select(age, caa, trtbps, thalachh),
            y = heartattack$output,
            scales = list(x = list(relation = "free"),
                          y = list(relation = "free")),
            plot = "density", pch = "|",
            auto.key = list(columns = 2))
```



```{r}
x <- model.matrix(output~age+caa+trtbps+chol+thalachh, heartattack)[,-11]
y <- heartattack$output
corrplot::corrplot(cor(x))
```

## glm/glmn
```{r}
set.seed(100)
ctrl = trainControl(method = "cv",
                    summaryFunction = twoClassSummary,
                    classProbs = TRUE)
glm.fit = glm(output ~ .,
              data = heartattack,
              subset = indexTrain,
              family = binomial(link = "logit"))
summary(glm.fit)
```


```{r}
glmnGrid <- expand.grid(.alpha = seq(0, 1, length = 11),
                        .lambda = exp(seq(2, -2, length = 35)))
set.seed(100)
model.glmn <- train(x = x_train,
                    y = y_train,
                    method = "glmnet",
                    tuneGrid = glmnGrid,
                    metric = "ROC",
                    trControl = ctrl)

model.glmn$bestTune

myCol<- rainbow(15)
myPar <- list(superpose.symbol = list(col = myCol),
              superpose.line = list(col = myCol))

plot(model.glmn, par.settings = myPar, xTrans = function(x) log(x))
```

## GAM
```{r}
set.seed(100)
gam.fit <- train(x_train,y_train,
                 method="gam",
                 #tuneGrid = data.frame(method = "GCV.Cp",select=c(TRUE,FALSE)),
                 trControl = ctrl)
gam.fit$bestTune
gam.fit$results
gam.fit$finalModel
```

## Mars
```{r, warning=FALSE}
set.seed(5009)
model.mars <- train(x = x_train,
                    y = y_train,
                    method = "earth",
                    tuneGrid = expand.grid(degree = 1:3, 
                                           nprune = 2:15),
                    metric = "ROC",
                    trControl = ctrl)

plot(model.mars)

coef(model.mars$finalModel) %>% knitr::kable(col.names = "Coefficient") 

pdp::partial(model.mars, pred.var = c("age"), grid.resolution = 200) %>% autoplot()
vip(model.mars$finalModel)

```


## LDA

```{r}
partimat(output ~ horsepower+displacement+acceleration+weight, 
         data = heartattack, subset = indexTrain, method = "lda")
```
```{r}
lda.fit <- lda(diabetes~., data = dat,
               subset = rowTrain)

```

